ä¸ªäººçš„Unityæ¸¸æˆå¼€å‘å¥—ä»¶ä¸ä¸€äº›ç¤ºä¾‹é¡¹ç›®ã€‚ï¼ˆå¼€å‘ä¸­ï¼Œå½“å‰Unityç‰ˆæœ¬2022.3.x LTSï¼‰

å¼€å‘å¥—ä»¶åŸºæœ¬æˆå‹ï¼Œå°†ä¼šéšç€ä¸ªäººå‚ä¸çš„é¡¹ç›®ä¸è¿™é‡Œçš„ç¤ºä¾‹é¡¹ç›®çš„å¼€å‘è€Œä¸æ–­æ›´æ–°ã€‚

ç¤ºä¾‹é¡¹ç›®é¾Ÿé€Ÿå¼€å‘ä¸­ï¼Œä¸»è¦åŒ…å«ä¸€äº›å…·æœ‰ä»£è¡¨æ€§çš„ã€åŠŸèƒ½è¾ƒä¸ºå¸¸è§ä¸é€šç”¨çš„é¡¹ç›®ï¼Œå…¶ä¸­çš„åŠŸèƒ½æ¨¡å—å¯å¤ç”¨åˆ°å…·æœ‰ç±»ä¼¼éœ€æ±‚çš„é¡¹ç›®ä¸­ã€‚

# ç›®å½•
- [ç¤ºä¾‹é¡¹ç›®](#ç¤ºä¾‹é¡¹ç›®)
  - [Droid Gear (WIP)](#droid-gear-wip)
  - [Tiny Farm (WIP)](#tiny-farm-wip)
  - [Wizzywoods (WIP)](#wizzywoods-wip)
  - [Luban Example - Lubanç¤ºä¾‹](#luban-example---lubanç¤ºä¾‹)
  - [Benchmark - åŸºå‡†æµ‹è¯•](#benchmark---åŸºå‡†æµ‹è¯•)
    - [è‡ªç®¡ç†çš„Update](#è‡ªç®¡ç†çš„update)
- [å¼€å‘å¥—ä»¶](#å¼€å‘å¥—ä»¶)
  - [å®‰è£…](#å®‰è£…)
  - [é€šç”¨å·¥å…·](#é€šç”¨å·¥å…·)
  - [Gameplayæ¡†æ¶](#gameplayæ¡†æ¶)
    - [å¼€å§‹ä¸Šæ‰‹](#å¼€å§‹ä¸Šæ‰‹)
    - [æ¡†æ¶ç»“æ„](#æ¡†æ¶ç»“æ„)
    - [å¯¼æ¼”](#å¯¼æ¼”)
    - [å­ç³»ç»Ÿ](#å­ç³»ç»Ÿ)
    - [æ¸¸æˆå®ä½“](#æ¸¸æˆå®ä½“)
    - [äº‹ä»¶æ€»çº¿é›†æˆ](#äº‹ä»¶æ€»çº¿é›†æˆ)
    - [æœåŠ¡å®šä½å™¨](#æœåŠ¡å®šä½å™¨)
    - [åŒºåŸŸæš‚åœä¸å€é€Ÿ](#åŒºåŸŸæš‚åœä¸å€é€Ÿ)
    - [è‡ªç®¡ç†çš„äº‹ä»¶å‡½æ•°](#è‡ªç®¡ç†çš„äº‹ä»¶å‡½æ•°)

# ç¤ºä¾‹é¡¹ç›®
## Droid Gear (WIP)
[ğŸ”—](./samples/DroidGear/) ç±»å¹¸å­˜è€…ã€‚

![](./docs/images/droidgear_screenshot_1.png)

äº®ç‚¹ï¼š
- Characteræ¡†æ¶
- èƒ½åŠ›ç³»ç»Ÿï¼ˆå±æ€§ã€æŠ€èƒ½ã€Buff)
- æ¨¡å—åŒ–å‡çº§

## Tiny Farm (WIP)
[ğŸ”—](./samples/TinyFarm/) å†œåœºæ¨¡æ‹Ÿã€‚

## Wizzywoods (WIP)
[ğŸ”—](./samples/Wizzywoods/)å›åˆåˆ¶ç­–ç•¥Rogue-likeã€‚
![](./docs/images/wizzywoods_screenshot_1.jpg)

## Luban Example - Lubanç¤ºä¾‹
[ğŸ”—](./samples/LubanExample/) [é…ç½®å·¥å…·Luban](https://luban.doc.code-philosophy.com/)ä½¿ç”¨ç¤ºä¾‹ã€‚
![](./docs/images/luban_example.png)

## Benchmark - åŸºå‡†æµ‹è¯•
[ğŸ”—](./samples/Benchmark/)ä¸€äº›é’ˆå¯¹å¥—ä»¶çš„åŸºå‡†æµ‹è¯•ã€‚

### è‡ªç®¡ç†çš„Update
[ğŸ”—](./samples/Benchmark/Assets/Benchmark/CustomUpdate/) åœ¨[Gameplayæ¡†æ¶](#gameplayæ¡†æ¶)ä¸­å®ç°äº†ä¸€å¥—è‡ªç®¡ç†çš„äº‹ä»¶å‡½æ•°ï¼ˆOnCreateã€IUpdatableã€IFixedUpdatableç­‰ï¼‰ï¼Œä»¥å–ä»£UnityåŸç”Ÿçš„äº‹ä»¶å‡½æ•°ï¼ˆAwakeã€Startã€Updateã€FixedUpdateç­‰ï¼‰ã€‚ä¸åŸç”Ÿäº‹ä»¶å‡½æ•°ç›¸æ¯”ï¼Œè‡ªç®¡ç†çš„äº‹ä»¶å‡½æ•°æœ‰åºæ‰§è¡Œï¼Œä¸”æ‰§è¡Œæ•ˆç‡ç•¥é«˜äºåŸç”Ÿã€‚

åœ¨è¿™ä¸ªæµ‹è¯•ä¸­ï¼Œåœºæ™¯ä¸­æœ‰20000ä¸ªçŒ´å¤´åœ¨ä¸æ–­åœ°ç§»åŠ¨å’Œæ—‹è½¬ï¼Œæ¯”è¾ƒä½¿ç”¨è‡ªç®¡ç†å®ç°ï¼ˆIUpdatableï¼‰çš„å¸§ç‡ï¼Œå’Œä½¿ç”¨åŸç”Ÿäº‹ä»¶å‡½æ•°ï¼ˆUpdateï¼‰å®ç°çš„å¸§ç‡ï¼Œæ— è®ºæ˜¯ç¼–è¾‘å™¨ä¸­è¿è¡Œï¼Œè¿˜æ˜¯æ‰“åŒ…åè¿è¡Œï¼Œè‡ªç®¡ç†éƒ½æ¯”åŸç”Ÿçš„å¸§æ•°è¦é«˜äº›ã€‚

![](./docs/images/benchmark_custom_update_1.png)

Last: ä¸Šä¸€æ¬¡æ‰€æœ‰ç‰©ä½“Updateæ‰§è¡Œæ€»è€—æ—¶

Average: æ‰€æœ‰ç‰©ä½“Updateæ‰§è¡Œæ€»è€—æ—¶çš„å¹³å‡å€¼

# å¼€å‘å¥—ä»¶
## å®‰è£…
[UniTask](https://github.com/Cysharp/UniTask)æ˜¯PamisuKitçš„å”¯ä¸€ç¬¬ä¸‰æ–¹ä¾èµ–é¡¹ï¼Œéœ€è¦å…ˆå®‰è£…å®ƒï¼Œå¯ä»¥é€šè¿‡[git URL](https://github.com/Cysharp/UniTask/?tab=readme-ov-file#install-via-git-url)æ–¹å¼å®‰è£…ï¼Œæˆ–é€šè¿‡[Unity Package](https://github.com/Cysharp/UniTask/releases/)æ–¹å¼å®‰è£…ã€‚

ç„¶åå°†[src/PamisuKit](./src/PamisuKit/)æ–‡ä»¶å¤¹å¤åˆ¶åˆ°é¡¹ç›®çš„Packagesæ–‡ä»¶å¤¹ä¸‹å³å¯ã€‚

> TODO ä¹‹åå¢åŠ git URLä¸Unity Packageå®‰è£…æ–¹å¼

## é€šç”¨å·¥å…·
[ğŸ”—](./src/PamisuKit/Runtime/Common/)åŒ…å«ä¸€äº›åŸºç¡€çš„å·¥å…·å®ç°ã€‚

- ç®€æ˜“Addressableèµ„æºç®¡ç†
- æœ‰é™çŠ¶æ€æœº
- å¯¹è±¡æ± 
- äº‹ä»¶æ€»çº¿ï¼ˆé›¶GCï¼‰
- å·¥å…·ç±»ï¼ˆUnityã€éšæœºã€æ•°å­¦ç­‰ç­‰ï¼‰

## Gameplayæ¡†æ¶
[ğŸ”—](./src/PamisuKit/Runtime/Framework/)ä¸€å¥—æç®€ä¸”è½»é‡çš„Gameplayæ¡†æ¶ã€‚[æ¡†æ¶ç»“æ„UML](#æ¡†æ¶ç»“æ„)

- ç³»ç»Ÿå†…è§’è‰²åˆ’åˆ†æ¸…æ™°æ˜ç¡®æˆä½“ç³»
- æŠ›å¼ƒä¼ ç»Ÿå•ä¾‹æ¨¡å¼ï¼Œæ‰€æœ‰å•ä¾‹ï¼ˆå­ç³»ç»Ÿã€æœåŠ¡ç­‰ï¼‰æ›´æ˜“äºç®¡ç†
- è‡ªç®¡ç†çš„äº‹ä»¶å‡½æ•°ï¼Œäº‹ä»¶å‡½æ•°æœ‰åºæ‰§è¡Œä¸”æ•ˆç‡æ¯”åŸç”Ÿé«˜
- é›†æˆäº‹ä»¶æ€»çº¿ï¼Œæ— éœ€æ‰‹åŠ¨å¤„ç†äº‹ä»¶çš„å–æ¶ˆè®¢é˜…
- â€œåŒºåŸŸâ€è®©éƒ¨åˆ†å…ƒç´ æš‚åœã€å€é€ŸåŠŸèƒ½çš„å®ç°æ›´ç®€å•

### å¼€å§‹ä¸Šæ‰‹

é¦–å…ˆåˆ›å»ºä¸€ä¸ªç±»ç»§æ‰¿`AppDirector`ï¼Œè´Ÿè´£å¤„ç†æ•´ä¸ªæ¸¸æˆå±‚é¢çš„é€»è¾‘ï¼Œæ•´ä¸ªæ¸¸æˆåªä¼šæœ‰ä¸€ä¸ª`AppDirector`ã€‚

**App.cs**

```C#
using PamisuKit.Framework;

public class App : AppDirector<App>
{
}
```

å°†å…¶æŒ‚è½½åœ¨ä¸€ä¸ªæ¸¸æˆç‰©ä½“ä¸Šï¼Œå¦‚æœæ¸¸æˆæœ‰å¤šåœºæ™¯åˆ‡æ¢ï¼Œåˆ™éœ€è¦å‹¾é€‰Dont Destroy On Loadé€‰é¡¹ã€‚

![](./docs/images/framework_appdirector.png)

ç„¶ååˆ›å»ºåœºæ™¯/ç©æ³•/æ¸¸æˆæ¨¡å¼ç›¸å…³çš„`Director`ï¼Œè´Ÿè´£å¤„ç†è¯¥åœºæ™¯/ç©æ³•/æ¸¸æˆæ¨¡å¼å±‚é¢çš„é€»è¾‘ï¼Œä¾‹å¦‚æ¸¸æˆæœ‰æ ‡é¢˜ã€æˆ˜å½¹ä¸¤ç§æ¸¸æˆæ¨¡å¼ï¼Œåˆ™å¯ä»¥åˆ›å»ºTitleDirectorä¸CombatDirectorï¼š

**TitleDirector.cs**

```C#
using PamisuKit.Framework;

public class TitleDirector : Director
{
}
```

**CombatDirector.cs**

```C#
using PamisuKit.Framework;

public class CombatDirector : Director
{
}
```

åˆ†åˆ«åœ¨Titleåœºæ™¯ä¸Combatåœºæ™¯æŒ‚è½½å®ƒä»¬ï¼š

![](./docs/images/framework_director.png)

æ¥ä¸‹æ¥ç¼–å†™å…¶ä»–è„šæœ¬å³å¯ï¼Œåªéœ€è¦å°†`MonoBehaviour`æ›¿æ¢ä¸º`MonoEntity`ï¼Œä¸è¦ä½¿ç”¨åŸç”Ÿçš„äº‹ä»¶å‡½æ•°å¦‚`Update`ï¼Œè€Œæ˜¯ç”¨`IUpdatable`è¿™æ ·çš„æ¥å£æ›¿ä»£ï¼Œå…¶ä»–ç…§å¸¸ï¼š

```C#
using PamisuKit.Framework;
using UnityEngine;

public class Player : MonoEntity, IUpdatable
{
    [SerializeField]
    private float _moveSpeed;

    // Playerè¢«åˆå§‹åŒ–æ—¶æ‰§è¡Œ
    protected override void OnCreate()
    {
        base.OnCreate();
        // åˆå§‹åŒ–ç©å®¶è§’è‰²...
    }

    // åœ¨OnCreateæ‰§è¡Œå®Œæ¯•åçš„ä¸‹ä¸€å¸§æ‰§è¡Œ
    public void OnUpdate(float deltaTime)
    {
        // Updateé€»è¾‘...
    }

    // ä½¿ç”¨OnSelfDestroyæ›¿ä»£OnDestroy
    protected override void OnSelfDestroy()
    {
        base.OnSelfDestroy();
        // é”€æ¯é€»è¾‘...
    }
}
```

`MonoEntity`éœ€è¦åˆå§‹åŒ–åæ‰èƒ½å·¥ä½œï¼Œä»¥ä¸‹æ˜¯å‡ ç§åˆå§‹åŒ–æ–¹å¼ï¼š

**ç¤ºä¾‹1 åˆ›å»ºç‰©ä½“ã€æŒ‚è½½è„šæœ¬å¹¶åˆå§‹åŒ–**
```C#
public class CombatDirector : Director
{
    private void InitPlayer()
    {
        // å®ä¾‹åŒ–ç©å®¶ï¼Œå°†ä¼šåˆ›å»ºä¸€ä¸ªåä¸ºPlayerçš„ç‰©ä½“ï¼ŒæŒ‚è½½Playerè„šæœ¬ï¼Œå¹¶æ‰§è¡Œå…¶åˆå§‹åŒ–
        var player = Region.NewMonoEntity<Player>();
    }
}
```

**ç¤ºä¾‹2 å®ä¾‹åŒ–é¢„åˆ¶ä½“å¹¶åˆå§‹åŒ–**
```C#
public class MonsterSpawner : MonoEntity
{
    [SerializeField]
    private GameObject _monsterPrefab;

    public void SpawnMonster()
    {
        // å®ä¾‹åŒ–Monsteré¢„åˆ¶ä½“
        var monster = Instantiate(_monsterPrefab, Trans).GetComponent<Monster>();
        // åˆå§‹åŒ–
        monster.Setup(Region);
    }
}
```

**ç¤ºä¾‹3 å‹¾é€‰Auto Setupè‡ªåŠ¨åˆå§‹åŒ–**

![](./docs/images/framework_autosetup_1.png)

### æ¡†æ¶ç»“æ„
![](./docs/images/framework_uml_class.jpg)

### å¯¼æ¼”
å¯¼æ¼”`Director`è´Ÿè´£å¤„ç†æŸä¸ªåœºæ™¯/ç©æ³•/æ¸¸æˆæ¨¡å¼å±‚é¢çš„é€»è¾‘ï¼Œè¿™ç±»é€»è¾‘éƒ½å¯ä»¥æ”¾åˆ°å…¶ä¸­ã€‚`Director`åŒæ—¶åªèƒ½å­˜åœ¨ä¸€ä¸ªï¼Œåœºæ™¯ä¸­æ‰€æœ‰çš„`MonoEntity`éƒ½ä¼šæ³¨å†Œåˆ°`Director`ä¸­ï¼Œ`MonoEntity`ä¸­å¯ä»¥ä½¿ç”¨`GetDirector`å‡½æ•°è·å–åˆ°å½“å‰`Director`ï¼š

```C#
public class Player : MonoEntity
{
    public void Foo()
    {
        var director = GetDirector<CombatDirector>();
        // ...
    }
}
```

> `GetDirector`çš„å¼€é”€éå¸¸å°ï¼Œä¸éœ€è¦åƒ`GetComponent`é‚£æ ·å°†ç»“æœä¿å­˜ä¸ºæˆå‘˜å˜é‡

`Director`æœ‰ä¸¤ç§æ¨¡å¼ï¼Œ`Normal`å’Œ`Global`ï¼Œå¯ä»¥åœ¨Inspectorä¸­è®¾ç½®ã€‚`Global`æ¨¡å¼é€‚åˆæ•´ä¸ªæ¸¸æˆåªæœ‰ä¸€ä¸ªDirectorå­˜åœ¨çš„æƒ…å†µã€‚

åœºæ™¯åŠ è½½åï¼Œåœºæ™¯ä¸­çš„ç¬¬ä¸€ä¸ªDirectorå°†è¢«åˆå§‹åŒ–ã€‚å½“ä¸€ä¸ªæ¨¡å¼ä¸º`Global`çš„Directorè¢«åˆå§‹åŒ–åï¼Œå®ƒå°†æˆä¸ºAppçš„å­ç‰©ä½“ï¼Œä¸éšåœºæ™¯åˆ‡æ¢è€Œé”€æ¯ï¼ˆå‰ææ˜¯Appå‹¾é€‰äº†Dont Destroy On Loadï¼‰ï¼Œä¹‹åå†åŠ è½½å…¶ä»–åœºæ™¯ï¼Œå…¶ä¸­çš„Directorå°†ä¸ä¼šè¢«åˆå§‹åŒ–ã€‚

### å­ç³»ç»Ÿ
å­ç³»ç»Ÿè´Ÿè´£å¤„ç†ç‰¹å®šåŠŸèƒ½æ¨¡å—çš„é€»è¾‘ï¼Œè¿™ä¸ªåŠŸèƒ½æ¨¡å—å¯ä»¥æ˜¯å…¨å±€çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯ç‰¹å®šæ¸¸æˆæ¨¡å¼ä¸‹çš„ï¼Œä¾‹å¦‚å­˜æ¡£ç³»ç»Ÿã€æˆå°±ç³»ç»Ÿã€ç‰©å“ä¸èƒŒåŒ…ç³»ç»Ÿã€å•†åº—ç³»ç»Ÿç­‰ç­‰ã€‚å­ç³»ç»Ÿå¿…é¡»é€šè¿‡`Director`æˆ–`AppDirector`æ¥åˆ›å»ºã€‚

ç¼–å†™ä¸€ä¸ªå­ç³»ç»Ÿç±»ï¼Œç»§æ‰¿`MonoSystem`ï¼š

**SaveSystem.cs**

```C#
using PamisuKit.Framework;

public class SaveSystem : MonoSystem
{
    // è¢«åˆ›å»ºæ—¶è°ƒç”¨
    protected override void OnCreate()
    {
        base.OnCreate();
        // åˆå§‹åŒ–é€»è¾‘...
    }
}
```

åœ¨`Director`ä¸­ä½¿ç”¨`CreateMonoSystem`å‡½æ•°æ¥åˆ›å»ºå®ƒï¼š

```C#
using PamisuKit.Framework;

public class CombatDirector : Director
{
    protected override void OnCreate()
    {
        base.OnCreate();
        CreateMonoSystem<SaveSystem>();
    }
}
```

è¿™æ ·åœ¨è¿è¡Œæ—¶å°†ä¼šåœ¨CombatDirectorç‰©ä½“ä¸‹åˆ›å»ºä¸€ä¸ªæŒ‚è½½äº†`SaveSystem`è„šæœ¬çš„ç‰©ä½“ã€‚

åœ¨ä¸Šé¢çš„åŸºç¡€ä¸Šï¼Œä¹Ÿå¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­ç»™Directorç‰©ä½“ä¸‹åˆ›å»ºå­ç‰©ä½“å¹¶æŒ‚è½½`SaveSystem`è„šæœ¬ï¼Œæ–¹ä¾¿åœ¨Inspectorä¸­è®¾ç½®å‚æ•°ï¼Œå½“`CreateMonoSystem<SaveSystem>()`æ‰§è¡Œæ—¶ï¼Œä¼šè‡ªåŠ¨è·å–SaveSystemå­ç‰©ä½“å¹¶å°†å…¶åˆå§‹åŒ–ã€‚

![](./docs/images/framework_system.png)

åœ¨`MonoEntity`ä¸­ï¼Œä½¿ç”¨`GetSystem`å‡½æ•°è·å–æŒ‡å®šç±»å‹çš„å­ç³»ç»Ÿå®ä¾‹ï¼š

```C#
public class Player : MonoEntity
{
    public void Foo()
    {
        var saveSystem = GetSystem<SaveSystem>();
        // ...
    }
}
```

> `GetSystem`çš„å¼€é”€åŒæ ·ä¹Ÿéå¸¸å°

> `MonoSystem`ç»§æ‰¿è‡ª`MonoEntity`

å¦‚æœä¸€ä¸ªå­ç³»ç»Ÿéœ€è¦åœ¨æ•´ä¸ªæ¸¸æˆå±‚é¢å…¨å±€å­˜åœ¨ï¼Œå¯ä»¥å°†å®ƒæ”¾åˆ°`AppDirector`ä¸­åˆ›å»ºã€‚

### æ¸¸æˆå®ä½“
`MonoEntity`æ˜¯ç»„æˆæ¸¸æˆä¸–ç•Œçš„å®ä½“ï¼ŒDirectorå’Œå­ç³»ç»Ÿä¹‹å¤–çš„èŒè´£éƒ½å¯ä»¥äº¤ç»™`MonoEntity`å®ç°ã€‚

`MonoEntity`éœ€è¦è¢«åŒ…å«åœ¨ä¸€ä¸ª`Region`å³â€œåŒºåŸŸâ€å†…ï¼Œæ¯ä¸ª`MonoEntity`åˆå§‹åŒ–æ—¶éœ€è¦æŒ‡å®šå…¶`Region`ï¼Œ`Director`ä¸­ä¼šåŒ…å«ä¸€ä¸ªé»˜è®¤çš„`Region`ï¼Œåˆå§‹åŒ–æ—¶ä¼ å…¥çš„`Region`å‚æ•°å°†ä¼šèµ‹å€¼ç»™æˆå‘˜å˜é‡ï¼Œåœ¨åˆå§‹åŒ–å…¶ä»–`MonoEntity`æ—¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªå˜é‡ã€‚

```C#
public class MonsterSpawner : MonoEntity
{
    [SerializeField]
    private GameObject _monsterPrefab;

    public void SpawnMonster()
    {
        // å®ä¾‹åŒ–Monsteré¢„åˆ¶ä½“
        var monster = Instantiate(_monsterPrefab, Trans).GetComponent<Monster>();
        // åˆå§‹åŒ–
        monster.Setup(Region);
    }
}
```

å½“åœ¨Inspectorä¸­å‹¾é€‰`Auto Setup`åï¼Œ`MonoEntity`å°†ä¼šè‡ªåŠ¨åˆå§‹åŒ–ï¼š

![](./docs/images/framework_autosetup_1.png)

ä¹Ÿå¯ä»¥åœ¨ä»£ç ä¸­è¦†å†™ï¼ˆä¼˜å…ˆä½¿ç”¨æ­¤å€¼ï¼‰ï¼š

```C#
public class Player : MonoEntity
{
    protected override bool AutoSetupOverride => true;
}
```

è‡ªåŠ¨åˆå§‹åŒ–å°†ä¼šå¯»æ‰¾åœºæ™¯ä¸­ç¬¬ä¸€ä¸ª`Director`ï¼Œè°ƒç”¨å®ƒçš„ç›¸åº”å‡½æ•°ï¼Œä½¿ç”¨å…¶ä¸­çš„é»˜è®¤`Region`æ¥åˆå§‹åŒ–è‡ªèº«ã€‚éœ€è¦æ³¨æ„è‡ªåŠ¨åˆå§‹åŒ–å°†ä¼šè®©äº‹ä»¶å‡½æ•°çš„æ‰§è¡Œå›å½’æ— åºï¼ˆè§[è‡ªç®¡ç†çš„äº‹ä»¶å‡½æ•°](#è‡ªç®¡ç†çš„äº‹ä»¶å‡½æ•°)ï¼‰ï¼Œè€ƒè™‘åˆ°ç›®å‰å¤§éƒ¨åˆ†ä½¿ç”¨åœºæ™¯éƒ½æ˜¯æ‰‹åŠ¨åˆå§‹åŒ–ï¼Œè¯¥é€‰é¡¹é»˜è®¤ä¸å‹¾é€‰ï¼ˆä¸ºfalseï¼‰ï¼Œå¯ä»¥åœ¨Project Settings -> Player -> Other Settings -> Scripting Define Symbolsä¸­æ·»åŠ `PAMISUKIT_ENTITY_AUTOSETUP_DEFAULT_ON`å°†å…¶æ”¹ä¸ºé»˜è®¤trueã€‚

![](./docs/images/framework_autosetup_macro.png)

å¦‚æœ`Director`çš„åˆå§‹åŒ–ä¸ºè€—æ—¶æ“ä½œï¼Œéœ€è¦ç­‰å¾…`Director`åˆå§‹åŒ–å®Œæ¯•åæ‰å¼€å§‹`MonoEntity`çš„è‡ªåŠ¨åˆå§‹åŒ–ï¼Œå¯ä»¥åœ¨`Director`ä¸­è‡ªå®šä¹‰è¿™ä¸ªè¿‡ç¨‹ï¼Œè¯¦è§[Luban Example](#luban-example---lubanç¤ºä¾‹)ä¸­çš„[GameDirector.cs](samples\LubanExample\LubanExampleUnity\Assets\Scripts\Game\GameDirector.cs)ã€‚

### äº‹ä»¶æ€»çº¿é›†æˆ

é€šç”¨å·¥å…·ä¸­åŒ…å«äº†ä¸€ä¸ª[äº‹ä»¶æ€»çº¿å®ç°](./src/PamisuKit/Runtime/Common/EventBus.cs)ï¼Œå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¸‹é¢æ˜¯ç‹¬ç«‹äºGameplayæ¡†æ¶çš„ç”¨æ³•ï¼š

```C#
// å®šä¹‰ä¸€ä¸ªäº‹ä»¶
public struct GreetingEvent
{
    public string Message;
}

public class A : MonoBehaviour
{
    public void Foo()
    {
        // å‘é€äº‹ä»¶
        EventBus.Emit(new GreetingEvent { Message = "Hello!"});
    }
}

public class B : MonoBehaviour
{
    private void Start()
    {
        // è®¢é˜…äº‹ä»¶
        EventBus.OnRaw<GreetingEvent>(OnGreeting);
    }

    private void OnDestroy()
    {
        // å–æ¶ˆè®¢é˜…
        EventBus.Off<GreetingEvent>(OnGreeting);
    }

    private void OnGreeting(GreetingEvent e)
    {
        Debug.Log($"Message: {e.Message}");
    }
}
```

äº‹ä»¶æ€»çº¿åœ¨è§£è€¦åˆæ—¶éå¸¸æœ‰ç”¨ï¼Œä½†éœ€è¦è®°å¾—å–æ¶ˆè®¢é˜…ï¼Œå¦åˆ™å®¹æ˜“å‡ºé—®é¢˜ã€‚Gameplayæ¡†æ¶åœ¨`MonoEntity`ä¸­åšäº†äº‹ä»¶æ€»çº¿çš„é›†æˆï¼Œäº‹ä»¶è®¢é˜…ä¼šè¢«è‡ªåŠ¨ç®¡ç†ï¼Œä¸‹é¢æ˜¯åŸºäºGameplayæ¡†æ¶çš„ç”¨æ³•ï¼š

```C#
// å®šä¹‰ä¸€ä¸ªäº‹ä»¶
public struct GreetingEvent
{
    public string Message;
}

public class A : MonoEntity
{
    public void Foo()
    {
        // å‘é€äº‹ä»¶
        Emit(new GreetingEvent { Message = "Hello!"});
    }
}

public class B : MonoEntity
{
    protected override void OnCreate()
    {
        base.OnCreate();
        // è®¢é˜…äº‹ä»¶ï¼Œæ— éœ€æ‰‹åŠ¨å–æ¶ˆè®¢é˜…
        On<GreetingEvent>(OnGreeting);
    }

    private void OnGreeting(GreetingEvent e)
    {
        Debug.Log($"Message: {e.Message}");
    }
}
```

å½“Bé”€æ¯æ—¶ï¼Œå°†ä¼šè‡ªåŠ¨å–æ¶ˆæ‰€æœ‰äº‹ä»¶è®¢é˜…ï¼Œè¿™ä¸ªå°è£…ä»…ä¼šåœ¨è®¢é˜…äº‹ä»¶æ—¶äº§ç”Ÿä¸€ä¸ªè®¢é˜…å¯¹è±¡çš„å†…å­˜å ç”¨ï¼Œå¤§å°å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚

### æœåŠ¡å®šä½å™¨
ä¸Šé¢é€šè¿‡äº†è§£`GetDirector`å’Œ`GetSystem`çš„ä½¿ç”¨å¯ä»¥å‘ç°ï¼Œæ¡†æ¶ä½¿ç”¨æœåŠ¡å®šä½å™¨æ¨¡å¼æ›¿ä»£äº†ä¼ ç»Ÿå•ä¾‹æ¨¡å¼ï¼Œä¸ä¼ ç»Ÿå•ä¾‹æ¨¡å¼ç›¸æ¯”æ›´åŠ çµæ´»å’Œæ–¹ä¾¿ç®¡ç†ã€‚

å¦‚æœæ¸¸æˆä¸­å­˜åœ¨æ— æ³•åˆ’åˆ†åˆ°Directorå’Œå­ç³»ç»ŸèŒè´£çš„ç±»ï¼Œä½†åˆéœ€è¦æœ‰å•ä¾‹åŠŸèƒ½ï¼Œå¯ä»¥å°†å…¶æ³¨å†ŒæˆæœåŠ¡ï¼š

```C#
using PamisuKit.Framework;

public class SomeService : MonoEntity
{
    // åˆ›å»ºæ—¶æ³¨å†Œ
    protected override void OnCreate()
    {
        base.OnCreate();
        GetDirector<Director>().AppDirector.RegisterService(this);
    }

    // é”€æ¯æ—¶ç§»é™¤
    protected override void OnSelfDestroy()
    {
        base.OnSelfDestroy();
        GetDirector<Director>().AppDirector.RemoveService(this);
    }
}
```

åœ¨`MonoEntity`ä¸­ï¼Œä½¿ç”¨AppDirectorçš„`GetService`æ¥è·å–æŒ‡å®šæœåŠ¡ï¼š

```C#
public class Player : MonoEntity
{
    public void Bar()
    {
        var service = GetDirector<Director>().AppDirector.GetService<SomeService>();
        // ...
    }
}
```

### åŒºåŸŸæš‚åœä¸å€é€Ÿ
åŒºåŸŸ`Region`æ˜¯æ¸¸æˆå®ä½“`MonoEntity`çš„å®é™…ç®¡ç†è€…ï¼Œæ¯ä¸ª`MonoEntity`åˆå§‹åŒ–åéƒ½ä¼šè¢«åŒ…å«åœ¨ä¸€ä¸ªåŒºåŸŸå†…ã€‚åŒºåŸŸä½¿ç”¨ä¸€ä¸ªé’Ÿè¡¨`Ticker`æ¥é©±åŠ¨æ‰€æœ‰`MonoEntity`çš„äº‹ä»¶å‡½æ•°ï¼Œé€šè¿‡ä¿®æ”¹`Ticker`çš„`TimeScale`æ¥å½±å“åŒºåŸŸå†…ç‰©ä½“çš„æ—¶é—´æµé€Ÿã€‚

ä¾‹å¦‚ä½¿ç”¨`IUpdatable`æ—¶ï¼Œä¼ å…¥çš„`deltaTime`ä¼šå—åˆ°`TimeScale`çš„å½±å“:

```C#
public class Ball : MonoEntity, IUpdatable
{
    // ...    
    public void OnUpdate(float deltaTime)
    {
        Trans.Translate(_moveSpeed * deltaTime * _moveDirection, Space.World);
    }
}
```

é€šè¿‡ä»¥ä¸‹ä»£ç ä¿®æ”¹`Ticker`çš„`TimeScale`ï¼Œçƒçš„è¿åŠ¨å°†ä¼šå˜æ…¢ï¼š

```C#
public void Foo()
{
    Region.Ticker.TimeScale = 0.5f;
}
```

å¯¹äº`IFixedUpdatable`ï¼Œ`deltaTime`å›ºå®šä¸º`Time.fixedDeltaTime`ï¼Œä¸ä¼šå—åˆ°`TimeScale`çš„å½±å“ï¼Œä½†å¯ä»¥ç›´æ¥ä½¿ç”¨`TimeScale`ä¿®æ”¹åˆšä½“é€Ÿåº¦ï¼š

```C#
public class PhysicsBall : MonoEntity, IFixedUpdatable
{
    // ...
    public void OnFixedUpdate(float deltaTime)
    {
        _rigidbody.velocity = _moveSpeed * Region.Ticker.TimeScale * _moveDirection;
    }
}
```

ä¸€ä¸ªå¸¸è§çš„éœ€æ±‚æ˜¯ï¼Œæ¸¸æˆå†…å®¹åœ¨æš‚åœå’Œå€é€Ÿæ—¶ï¼ŒUIå†…å®¹ä¸å—å½±å“ï¼Œå¯ä»¥é€šè¿‡å°†æ¸¸æˆå†…å®¹å’ŒUIå†…å®¹æ”¾åœ¨ä¸åŒåŒºåŸŸæ¥å®ç°ï¼Œè¯¦è§ç¤ºä¾‹é¡¹ç›®[Droid Gear](#droid-gear)ä¸­çš„[GameDirector.cs](./samples/DroidGear/Assets/Scripts/Game/GameDirector.cs)ã€‚

### è‡ªç®¡ç†çš„äº‹ä»¶å‡½æ•°
UnityåŸç”Ÿçš„äº‹ä»¶å‡½æ•°ï¼ˆAwakeã€Startã€Updateã€FixedUpdateç­‰ï¼‰æœ‰ä¸€ä¸ªç—›ç‚¹ï¼Œå®ƒä»¬é»˜è®¤æ˜¯æ— åºæ‰§è¡Œçš„ï¼Œå¦‚æœéœ€è¦è°ƒæ•´æ‰§è¡Œé¡ºåºï¼Œéœ€è¦åœ¨Script Execution Orderé‡Œæ‰‹åŠ¨è®¾ç½®ã€‚

æ— åºæ‰§è¡Œå®¹æ˜“å¸¦æ¥ä¸€äº›éº»çƒ¦ï¼Œäº§ç”Ÿä¸€äº›æ„æƒ³ä¸åˆ°çš„Bugï¼Œä¾‹å¦‚åœºæ™¯ä¸­æœ‰Aã€Bä¸¤ä¸ªMonoBehaviourï¼ŒäºŒè€…éƒ½éœ€è¦åœ¨Startå‡½æ•°ä¸­åšåˆå§‹åŒ–ï¼Œè€ŒBéœ€è¦ä¾èµ–Aï¼Œç”±äºABäºŒè€…çš„Startå‡½æ•°æ‰§è¡Œé¡ºåºä¸ç¡®å®šï¼ŒBçš„åˆå§‹åŒ–å¯èƒ½ä¼šå› æ­¤å¤±è´¥ï¼Œä¸å¾—ä¸å°†Açš„åˆå§‹åŒ–æå‰è‡³Awakeå‡½æ•°ã€‚é¡¹ç›®ä¸­ç±»ä¼¼çš„æƒ…å†µå˜å¤šä¹‹åï¼Œå„è„šæœ¬çš„åˆå§‹åŒ–å°†ä¼šå˜å¾—éš¾ä»¥åè°ƒã€‚

æ‰‹åŠ¨ç®¡ç†æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼Œå¹¶ä¸”ä¹Ÿç¬¦åˆå¾ˆå¤šåº”ç”¨åœºæ™¯ï¼Œä¾‹å¦‚ä¸€ä¸ªæˆ˜æ–—åœºæ™¯ä¸­ï¼Œæ¸¸æˆçš„å…¨å±€ç®¡ç†ç±»å…ˆåˆå§‹åŒ–ï¼Œéšåè°ƒç”¨æˆ˜æ–—ç®¡ç†ç±»çš„åˆå§‹åŒ–ï¼Œåœ¨å…¶ä¸­ç”Ÿæˆç©å®¶ä¸æ•Œäººï¼Œæœ€åè°ƒç”¨ç©å®¶ä¸æ•Œäººçš„åˆå§‹åŒ–ã€‚ä½†è¿™ä»æœ‰ä¸€ç‚¹ç¼ºé™·ï¼ŒUpdateã€FixedUpdateã€LateUpdateç­‰å‡½æ•°ä¾ç„¶æ˜¯ä¹±åºæ‰§è¡Œçš„ã€‚

åœ¨æœ¬Gameplayæ¡†æ¶ä¸­ï¼Œç€é‡è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä»¥ä¸Šé¢çš„æˆ˜æ–—åœºæ™¯ä¸ºä¾‹ï¼Œå¯ä»¥ç¼–å†™ä»¥ä¸‹ä»£ç ï¼š

```C#
// æ¸¸æˆçš„å…¨å±€ç®¡ç†ç±»/å…¨å±€å®ä¾‹
public class App : AppDirector<App>
{
    // Appçš„OnCreateæœ€å…ˆæ‰§è¡Œ
    protected override void OnCreate()
    {
        // åˆå§‹åŒ–Directorä¾èµ–åˆ°çš„å…¨å±€ç³»ç»Ÿ
        // ...
        // OnCreateä¸­ä¼šåˆå§‹åŒ–å½“å‰Director
        base.OnCreate();
    }
}

// æˆ˜æ–—åœºæ™¯ä¸­æˆ˜æ–—é€»è¾‘çš„ç®¡ç†ç±»
public class CombatDirector : Director
{
    // Appåˆå§‹åŒ–å®Œæ¯•åï¼ŒCombatDirectorçš„OnCreateæ‰ä¼šæ‰§è¡Œ
    protected override void OnCreate()
    {
        base.OnCreate();
        // åˆå§‹åŒ–æˆ˜æ–—ç›¸å…³ç³»ç»Ÿ...
        // ...
        // å®ä¾‹åŒ–ç©å®¶
        var player = Region.NewMonoEntity<Player>();
    }
}

// ç©å®¶è§’è‰²
public class Player : MonoEntity, IUpdatable
{
    // ç©å®¶è¢«ç”Ÿæˆæ—¶æ‰§è¡Œ
    protected override void OnCreate()
    {
        base.OnCreate();
        // åˆå§‹åŒ–ç©å®¶è§’è‰²...
    }

    // åœ¨OnCreateæ‰§è¡Œå®Œæ¯•åçš„ä¸‹ä¸€å¸§æ‰§è¡Œ
    public void OnUpdate(float deltaTime)
    {
        // Updateé€»è¾‘...
    }
}
```
